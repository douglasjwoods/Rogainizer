#cloud-config
package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - gnupg
  - git
  - ufw
  - jq

write_files:
  - path: /usr/local/bin/rogainizer-autodeploy-metadata.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      REPO_URL="https://github.com/your-org/your-repo.git"
      REPO_REF="main"
      APP_DIR="/opt/rogainizer"

      METADATA_URL="http://169.254.169.254/metadata/v1/vendor-data"

      if [[ "$REPO_URL" == "https://github.com/your-org/your-repo.git" ]]; then
        echo "REPO_URL is still placeholder. Edit deploy/digitalocean-cloud-init-autodeploy-metadata.yaml before use."
        exit 1
      fi

      if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com | sh
      fi

      systemctl enable docker
      systemctl start docker

      if id -nG ubuntu | grep -qw docker; then
        :
      else
        usermod -aG docker ubuntu
      fi

      ufw allow OpenSSH
      ufw allow 80
      ufw allow 443
      ufw --force enable

      timedatectl set-timezone Pacific/Auckland || true

      install -d -m 700 -o ubuntu -g ubuntu /home/ubuntu/.ssh
      touch /home/ubuntu/.ssh/known_hosts
      chmod 644 /home/ubuntu/.ssh/known_hosts
      chown ubuntu:ubuntu /home/ubuntu/.ssh/known_hosts
      ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> /home/ubuntu/.ssh/known_hosts || true

      METADATA_JSON="$(curl -fsSL "$METADATA_URL")"

      DOMAIN="$(echo "$METADATA_JSON" | jq -r '.rogainizer.domain // empty')"
      MYSQL_ROOT_PASSWORD="$(echo "$METADATA_JSON" | jq -r '.rogainizer.mysql_root_password // empty')"
      DB_USER="$(echo "$METADATA_JSON" | jq -r '.rogainizer.db_user // "root"')"
      DB_PASSWORD="$(echo "$METADATA_JSON" | jq -r '.rogainizer.db_password // empty')"
      DB_NAME="$(echo "$METADATA_JSON" | jq -r '.rogainizer.db_name // "rogainizer"')"
      SSH_KEY_B64="$(echo "$METADATA_JSON" | jq -r '.rogainizer.github_deploy_key_base64 // empty')"

      if [[ -z "$DOMAIN" || -z "$MYSQL_ROOT_PASSWORD" || -z "$DB_PASSWORD" ]]; then
        echo "Missing required metadata keys under rogainizer: domain, mysql_root_password, db_password"
        exit 1
      fi

      if [[ -n "$SSH_KEY_B64" ]]; then
        echo "$SSH_KEY_B64" | base64 -d > /home/ubuntu/.ssh/id_ed25519
        chmod 600 /home/ubuntu/.ssh/id_ed25519
        chown ubuntu:ubuntu /home/ubuntu/.ssh/id_ed25519
        export GIT_SSH_COMMAND="ssh -i /home/ubuntu/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes"
      fi

      mkdir -p /opt

      if [[ ! -d "$APP_DIR/.git" ]]; then
        git clone "$REPO_URL" "$APP_DIR"
      fi

      cd "$APP_DIR"
      git fetch --all --prune
      git checkout "$REPO_REF"
      git pull --ff-only origin "$REPO_REF"

      cat > .env.production <<EOF
      DOMAIN=${DOMAIN}
      MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      DB_USER=${DB_USER}
      DB_PASSWORD=${DB_PASSWORD}
      DB_NAME=${DB_NAME}
      EOF

      docker compose --env-file .env.production -f docker-compose.prod.yml up -d --build

      for attempt in 1 2 3 4 5; do
        if docker compose --env-file .env.production -f docker-compose.prod.yml exec -T api npm run db:init; then
          break
        fi

        if [[ "$attempt" == "5" ]]; then
          echo "db:init failed after retries"
          exit 1
        fi

        sleep 8
      done

      chmod +x ./deploy/postdeploy-check.sh || true
      ./deploy/postdeploy-check.sh .env.production || true
      chmod +x ./deploy/first-boot-report.sh || true
      ./deploy/first-boot-report.sh .env.production /var/log/rogainizer-report.txt || true

runcmd:
  - [ bash, -lc, '/usr/local/bin/rogainizer-autodeploy-metadata.sh > /var/log/rogainizer-autodeploy.log 2>&1' ]

final_message: "Rogainizer metadata autodeploy cloud-init complete. Check /var/log/rogainizer-autodeploy.log"